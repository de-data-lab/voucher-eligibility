---
title: "Voucher_EDA"
author: "Mehak Gupta"
date: "1/18/2022"
output: html_document
---

```{r setup, include=FALSE, echo=FALSE}

knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
if (!require("pacman")) install.packages("pacman")
pacman::p_load(
    here,
    tidyverse,
    lubridate,
    tidycensus,
    tigris,
    acs,
    leaflet,
    mapview,
    viridis)

library(xml2)
library(tibble)
library(rvest)
library(stringr)
library(tidyr)
library(janitor)
library(dplyr)
library(pdftools)
library(readr)
library(leaflet)
library(tigris)
library(tidyverse)
library("ggpubr")
library(peRspective)
library(reshape)
library(plotly)
library(lubridate)
library(RColorBrewer)

# Load data
hud_de_section8 <- read_rds(here("data/processed/hud_de_section8.rds"))
pop <- read_csv(here('data/raw/pop2019.csv'))
rent <- read_csv(here('data/raw/rent019.csv'))
rent30 <- read_csv(here('data/raw/rent302019.csv'))

rent_income <- read_csv(here('data/raw/rent_income.csv'))


hud_de_section8<- hud_de_section8 %>% select("gsl","entities","sumlevel",
                       "program_label", "program","sub_program", "name", "GEOID",
                       "rent_per_month","hh_income","person_income","spending_per_month","number_reported")

de_summary_table <- hud_de_section8 %>% group_by(GEOID) %>% 
    mutate(tot = number_reported)


```

```{r, echo=FALSE}
eligible <- rent %>%
    inner_join(rent30, by="GEOID") %>%
    filter(med_rent_percE > 30)
```

```{r, echo=FALSE}
de_h30 <- hud_de_section8 %>% group_by(GEOID) %>% 
    summarize(rent = mean(rent_per_month),
              inc = mean(hh_income),
              pinc = mean(person_income),
              spending = mean(spending_per_month)) %>%
    mutate(h30 = 100*(rent/inc))
```

```{r, echo=FALSE}
eligible <- inner_join(rent,rent30,by="GEOID") %>% 
    filter(med_rent_percE>30)
shape <- tracts(state='10')

la <- geo_join(shape,
               eligible %>% mutate(GEOID=as.character(GEOID)),
               by="GEOID") %>%
    replace(is.na(.), 0) %>%
    filter(GEOID>0)

la$NAMELSAD <- gsub("Census Tract", "", la$NAMELSAD)
popUp <- with(la,paste0("<br><b>GEOID:</b> ", la$GEOID,
                        "<br><b>Census Tract:</b>",la$NAMELSAD,
                        "<br><b>Household Count (above 30%):</b>",la$above30,
                        "<br><b>*Percentage of hh_income on rent:</b> ", specify_decimal(la$med_rent_percE,2)
                        
))

cols <- colorNumeric(
    palette = "inferno",
    domain =la$med_rent_percE, reverse = TRUE
)
lat <- 39.1824#39.5393
lng <- -75.2
map <- la %>%
    leaflet() %>%
    addTiles(providers$CartoDB.Positron) %>%   #not including one, sets the general maps version
    setView(lng, lat, zoom = 8.0) %>%
    addPolygons(fillColor = ~cols(la$med_rent_percE),
                color = "#B2AEAE",
                fillOpacity = 1,
                weight = 1,
                smoothFactor = 0.4,
                popup = popUp
    ) %>%
    addLegend(pal = cols,
              values = la$med_rent_percE,
              position = "bottomright",
              title = paste("Percentage of hh_income on rent (above 30)",sep=" "))

```

```{r, echo=FALSE}

eligible <- inner_join(rent,rent30,by="GEOID")# %>% filter(med_rent_percE>30)

shape <- tracts(state='10')

la <- geo_join(shape,
               eligible %>% mutate(GEOID=as.character(GEOID)),
               by="GEOID") %>%
    replace(is.na(.), 0) %>%
    filter(GEOID>0)

la$NAMELSAD <- gsub("Census Tract", "", la$NAMELSAD)
popUp <- with(la,paste0("<br><b>GEOID:</b> ", la$GEOID,
                        "<br><b>Census Tract:</b>",la$NAMELSAD,
                        "<br><b>Household Count (above 30%):</b>",la$above30,
                        "<br><b>*Percentage of hh_income on rent:</b> ", specify_decimal(la$med_rent_percE,2)
                        
))

cols <- colorNumeric(
    palette = "inferno",
    domain =la$med_rent_percE, reverse = TRUE
)
lat <- 39.1824#39.5393
lng <- -75.2
map <- la %>%
    leaflet() %>%
    addTiles(providers$CartoDB.Positron) %>%   #not including one, sets the general maps version
    setView(lng, lat, zoom = 8.0) %>%
    addPolygons(fillColor = ~cols(la$med_rent_percE),
                color = "#B2AEAE",
                fillOpacity = 1,
                weight = 1,
                smoothFactor = 0.4,
                popup = popUp
    ) %>%
    addLegend(pal = cols,
              values = la$med_rent_percE,
              position = "bottomright",
              title = paste("Percentage of hh_income on rent (All)",sep=" "))

```

# hh_income brackets with 30% or more spent on rent

```{r, echo=FALSE}

data <- inner_join(de_summary_table,
                   rent_income %>%
                       mutate(GEOID=as.character(GEOID)),
                   by="GEOID") %>% mutate(county=substr(GEOID, 3, 5)) %>%
  mutate(rent_10k=sum(rent_30_10kE,rent_35_10kE,rent_40_10kE,rent_50_10kE),
         rent_20k=sum(rent_30_20kE,rent_35_20kE,rent_40_20kE,rent_50_20kE),
         rent_35k=sum(rent_30_35kE,rent_35_35kE,rent_40_35kE,rent_50_35kE),
         rent_50k=sum(rent_30_50kE,rent_35_50kE,rent_40_50kE,rent_50_50kE),
         rent_75k=sum(rent_30_75kE,rent_35_75kE,rent_40_75kE,rent_50_75kE))

data<-data %>% filter(tot>0)
```

# Number of Eligible household by amount of hh_income with 30% spent on rent category
```{r, echo=FALSE}
ggplot_cases_time_cont = data %>% group_by(county) %>% 
    summarize(tot_reported=sum(number_reported),
              tot_10k=sum(rent_10k),
              tot_20k=sum(rent_20k),
              tot_35k=sum(rent_35k),
              tot_50k=sum(rent_50k),
              tot_75k=sum(rent_75k))  %>% gather(inc_cat, count, -c(county)) %>%
  ## na.rm = TRUE ensures all values are NA are taken as 0
  ggplot(aes(x=county,y=count))+
  geom_bar(aes(fill=inc_cat),   # fill depends on cond2
             stat="identity",
             colour="black",    # Black outline for all
             position=position_dodge())+
  ylab("Total Count")+
  xlab("County")+
  labs(color = "Amount of hh_income with 30% spent on rent")+
  ggtitle("Number of Eligible household by amount of hh_income with 30% spent on rent category")

ggplotly(ggplot_cases_time_cont) %>%
    plotly_build()
```
# Number of Eligible household with hh_income less than 75k with 30% spent on rent.
```{r, echo=FALSE}
ggplot_cases_time_cont = data %>% group_by(county) %>% 
    summarize(tot_reported=sum(number_reported),
              less_50k=sum(rent_10k,rent_20k,rent_35k,rent_50k),
              less_75k=sum(rent_10k,rent_20k,rent_35k,rent_50k,rent_75k)) %>%
  select(county,less_75k,tot_reported) %>%
  gather(inc_cat, count, -c(county)) %>%
  ## na.rm = TRUE ensures all values are NA are taken as 0
  ggplot(aes(x=county,y=count))+
  geom_bar(aes(fill=inc_cat),   # fill depends on cond2
             stat="identity",
             colour="black",    # Black outline for all
             position=position_dodge())+
  ylab("Total Count")+
  xlab("County")+
  labs(color = "Amount of hh_income with 30% spent on rent")+
  ggtitle("")

ggplotly(ggplot_cases_time_cont) %>%
    plotly_build()
```

# Proportion of household with hh_income less than 75k and 30% spent on rent NOT receiving assisstance.
```{r, echo=FALSE}
ggplot_cases_time_cont = data %>% group_by(county) %>% 
    summarize(tot_reported=sum(number_reported),
              less_50k=sum(rent_10k,rent_20k,rent_35k,rent_50k),
              less_75k=sum(rent_10k,rent_20k,rent_35k,rent_50k,rent_75k)) %>% 
  mutate(perc_50=(less_50k - tot_reported)/less_50k,
         perc_75=(less_75k - tot_reported)/less_75k) %>%
  select(county,perc_75) %>%
  ## na.rm = TRUE ensures all values are NA are taken as 0
  ggplot(aes(x=county,y=perc_75))+
  geom_bar(aes(fill=county),   # fill depends on cond2
             stat="identity",
             colour="black",    # Black outline for all
             position=position_dodge())+
  ylab("Proportion")+
  xlab("County")+
  labs(color = "Amount of hh_income with 30% spent on rent")+
  ggtitle("")

ggplotly(ggplot_cases_time_cont) %>%
    plotly_build()
```

# 30% or more spent on rent with rent category
```{r, echo=FALSE}


data <- inner_join(de_summary_table,
                   eligible %>%
                       mutate(GEOID=as.character(GEOID)),
                   by="GEOID") 
#data$tot[data$tot==-4]<-10
dat30<-data %>% select('GEOID','rent_30E','tot') %>% mutate('perc_hh_income_rent'='rent_30_35') %>% dplyr::rename(elCount=rent_30E)
dat35<-data %>% select('GEOID','rent_35E','tot') %>% mutate('perc_hh_income_rent'='rent_35_40') %>% dplyr::rename(elCount=rent_35E)
dat40<-data %>% select('GEOID','rent_40E','tot') %>% mutate('perc_hh_income_rent'='rent_40_50') %>% dplyr::rename(elCount=rent_40E)
dat50<-data %>% select('GEOID','rent_50E','tot') %>% mutate('perc_hh_income_rent'='rent_50') %>% dplyr::rename(elCount=rent_50E)

data<-rbind(dat30,dat35)
data<-rbind(data,dat40)
data<-rbind(data,dat50)

data$county<-substr(data$GEOID, 3, 5)
data<-data %>% filter(tot>0)
```

# Number of Eligible household by percentage of hh_income spent on rent category
```{r, echo=FALSE}
ggplot_cases_time_cont = data %>% group_by(county,perc_hh_income_rent) %>% 
    summarize(count=sum(elCount)) %>%
  ## na.rm = TRUE ensures all values are NA are taken as 0
  ggplot(aes(x=county,y=count))+
  geom_bar(aes(fill=perc_hh_income_rent),   # fill depends on cond2
             stat="identity",
             colour="black",    # Black outline for all
             position=position_dodge())+
  ylab("Total Eligible")+
  xlab("County")+
  labs(color = "Percentage of hh_income spent on rent")+
  ggtitle("Number of Eligible household by percentage of hh_income spent on rent category")

ggplotly(ggplot_cases_time_cont) %>%
    plotly_build()
```

# Number of Eligible household vs Number reported for Kent
```{r, echo=FALSE}
ggplot_cases_time_cont = data %>% filter(county=='001') %>%
  ## na.rm = TRUE ensures all values are NA are taken as 0
  ggplot(aes(x=tot,y=elCount,
             color = perc_hh_income_rent))+
  geom_point()+
  theme_minimal()+
  ylab("Total Eligible")+
  xlab('Number Reported')+
  labs(color = "Percentage of hh_income spent on rent")+
  ggtitle("Number of Eligible household vs Number reported for Kent")

ggplotly(ggplot_cases_time_cont) %>%
    plotly_build()
```
# Number of Eligible household vs Number reported for NC
```{r, echo=FALSE}
ggplot_cases_time_cont = data %>% filter(county=='003') %>%
  ## na.rm = TRUE ensures all values are NA are taken as 0
  ggplot(aes(x=tot,y=elCount,
             color = perc_hh_income_rent))+
  geom_point()+
  theme_minimal()+
  ylab("Total Eligible")+
  xlab('Number Reported')+
  labs(color = "Percentage of hh_income spent on rent")+
  ggtitle("Number of Eligible household vs Number reported for NC")

ggplotly(ggplot_cases_time_cont) %>%
    plotly_build()
```
# Number of Eligible household vs Number reported for Sussex
```{r, echo=FALSE}
ggplot_cases_time_cont = data %>% filter(county=='005') %>%
  ## na.rm = TRUE ensures all values are NA are taken as 0
  ggplot(aes(x=tot,y=elCount,
             color = perc_hh_income_rent))+
  geom_point()+
  theme_minimal()+
  ylab("Total Eligible")+
  xlab('Number Reported')+
  labs(color = "Percentage of hh_income spent on rent")+
  ggtitle("Number of Eligible household vs Number reported for Sussex")

ggplotly(ggplot_cases_time_cont) %>%
    plotly_build()
```



# Number of household eligible for receiving rental assistance by housing vouchers
```{r, echo=FALSE}
ggplot_cases_time_cont = data %>% group_by(county) %>% 
    summarize(eligible=sum(elCount),reported=sum(tot)) %>%
    mutate(perc=(eligible)) %>%
  ## na.rm = TRUE ensures all values are NA are taken as 0
  ggplot(aes(x=county,y=perc))+
  geom_bar(aes(fill=county),   # fill depends on cond2
             stat="identity",
             colour="black",    # Black outline for all
             position=position_dodge())+
  ylab("")+
  xlab("County")+
  labs(color = "Number of household eligible for receiving rental assistance by housing vouchers")+
  ggtitle("Number of household eligible for receiving rental assistance by housing vouchers")

ggplotly(ggplot_cases_time_cont) %>%
    plotly_build()
```
# Number of household receiving rental assistance by housing vouchers
```{r, echo=FALSE}
ggplot_cases_time_cont = data %>% group_by(county) %>% 
    summarize(eligible=sum(elCount),reported=sum(tot)) %>%
    mutate(perc=(reported)) %>%
  ## na.rm = TRUE ensures all values are NA are taken as 0
  ggplot(aes(x=county,y=perc))+
  geom_bar(aes(fill=county),   # fill depends on cond2
             stat="identity",
             colour="black",    # Black outline for all
             position=position_dodge())+
  ylab("")+
  xlab("County")+
  labs(color = "Number of household receiving rental assistance by housing vouchers")+
  ggtitle("Number of household receiving rental assistance by housing vouchers")

ggplotly(ggplot_cases_time_cont) %>%
    plotly_build()
```
# Proportion of household not receiving rental assistance by housing vouchers
```{r, echo=FALSE}
ggplot_cases_time_cont = data %>% group_by(county) %>% 
    summarize(eligible=sum(elCount),reported=sum(tot)) %>%
    mutate(perc=(eligible-reported)/eligible) %>%
  ## na.rm = TRUE ensures all values are NA are taken as 0
  ggplot(aes(x=county,y=perc))+
  geom_bar(aes(fill=county),   # fill depends on cond2
             stat="identity",
             colour="black",    # Black outline for all
             position=position_dodge())+
  ylab("")+
  xlab("County")+
  labs(color = "Proportion of household not receiving rental assistance by housing vouchers")+
  ggtitle("Proportion of household not receiving rental assistance by housing vouchers")

ggplotly(ggplot_cases_time_cont) %>%
    plotly_build()
```

```{r, echo=FALSE}

data <- inner_join(de_summary_table,
                   eligible %>%
                       mutate(GEOID=as.character(GEOID)),
                   by="GEOID") %>%
    mutate(perc=(above30-tot)/above30)
data$tot[data$tot==-4]<-10
data$county<-substr(data$GEOID, 3, 5)
data<-data %>% filter(tot>0)

ggplot_cases_time_cont = data %>%
  ## na.rm = TRUE ensures all values are NA are taken as 0
  ggplot(aes(x=perc,y=med_rentE,
             color = county))+
  geom_point()+
  theme_minimal()+
  xlab("Proportion of household not receiving housing vouchers")+
  ylab('Median Rent')+
  labs(color = "County")+
  ggtitle("Relation between Number of Eligible household vs Median rent")

ggplotly(ggplot_cases_time_cont) %>%
    plotly_build()
```

```{r, echo=FALSE}

data <- inner_join(de_summary_table,
                   eligible %>%
                       mutate(GEOID=as.character(GEOID)),
                   by="GEOID") %>%
    mutate(perc=(above30-tot)/above30)

data <- inner_join(data,
                   pop %>%
                       mutate(GEOID=as.character(GEOID)),
                   by="GEOID")

data$tot[data$tot==-4]<-10
data$county<-substr(data$GEOID, 3, 5)
data<-data %>% filter(tot>0)

ggplot_cases_time_cont = data %>%
  ## na.rm = TRUE ensures all values are NA are taken as 0
  ggplot(aes(x=perc,y=hh_incE,
             color = county))+
  geom_point()+
  theme_minimal()+
  xlab("Proportion of household not receiving housing vouchers")+
  ylab('Household Income')+
  labs(color = "County")+
  ggtitle("Relation between Number of Eligible household vs Household Income")

ggplotly(ggplot_cases_time_cont) %>%
    plotly_build()
```